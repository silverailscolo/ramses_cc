name: Coverage
# based on: https://github.com/marketplace/actions/code-coverage-summary

on:
  push:
    branches: [ "master" ]
    paths: [
      ".github/workflows/check-cov.yml",
      "custom_components/ramses_cc/**.py",
      "pyproject.toml",
      "requirements/**",
      "tests/**",
    ]

  pull_request_target:
    branches: [ "master" ]
    paths: [
      ".github/workflows/check-cov.yml",
      "custom_components/ramses_cc/**.py",
      "pyproject.toml",
      "requirements/**",
      "tests/**",
    ]

  schedule:
    - cron: "0 7 * * 5"

  workflow_dispatch:

permissions:
  pull-requests: write

jobs:

  changed:
    runs-on: ubuntu-latest
    name: "Check what files changed"
    outputs:
      run_tests: ${{ steps.filter.outputs.run_tests }}
    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v6

      - name: "Examine changed files"
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            run_tests:
              - "**.py"
              - ".github/workflows/check-cov.yml"
              - "pyproject.toml"
              - "requirements/*.txt"

  coverage:
    runs-on: ubuntu-latest

    # Only run tests if files that affect tests have changed.
    # from: https://nedbatchelder.com/blog/202505/filtering_github_actions_by_changed_files.html
    needs: changed
    if: ${{ needs.changed.outputs.run_tests == 'true' }}

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements_test.txt

      - name: Run coverage with pytest
        run: coverage run -m pytest

      - name: Debug - Check if .coverage exists
        run: test -f .coverage && echo ".coverage exists" || echo ".coverage does NOT exist"

      - name: Display coverage report
        run: coverage report

      - name: Create coverage xml
        run: coverage xml

      - name: Create Code Coverage Report
        # from: https://github.com/marketplace/actions/code-coverage-summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: '66 85'

      - name: Add Coverage PR Comment
        # from: https://github.com/marketplace/actions/comment-pull-request
        if: github.event_name == 'pull_request_target'
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: code-coverage-results.md
          comment-tag: code-coverage-results.md  # replaces existing by this name
          mode: recreate
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#      - name: Create Coverage Badge
#        # from: https://github.com/marketplace/actions/coverage-py-badge
#        uses: tj-actions/coverage-badge-py@v2
#        id: coverage-badge-py
#        with:
#            # Output path to write the
#            # coverage badge.
#            # Type: string
#            # Default: "coverage.svg"
#            output: 'misc/coverage-badge.svg'
#
#            # Overwrite an existing coverage badge.
#            # Type: boolean
#            # Default: "true"
#            overwrite: ''
#
#            # Current working directory
#            # Type: string
#            # Default: "."
#            working-directory: ''

      - run: echo "üçè This job's status is ${{ job.status }}."
